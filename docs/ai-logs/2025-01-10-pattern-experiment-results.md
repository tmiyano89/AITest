# @Guideマクロ改善実験結果 - 2025年1月10日

## 📊 実験概要

### 目的
@Guideマクロ、@Generable、Instructions、Promptの組み合わせパターンを比較し、AFMの抽出精度傾向を把握する。

### 実験設定
- テストケース: 15個（5パターン × 3レベル）
- 実行環境: macOS 26.0, FoundationModels
- 評価指標: 正規化スコア、抽出時間、抽出フィールド数

## 🔬 実験結果

### パターン比較（正規化スコア）

| パターン | 正規化スコア | 平均抽出時間 | 平均抽出フィールド数 | 特記事項 |
|---------|-------------|-------------|-------------------|-------------|
| 抽象指示（デフォルト） | （参考値） | 1.635秒 | 2.8 | ベースライン |
| 厳格指示 | （参考値・ベースより高傾向） | 1.725秒 | 3.2 | 複雑ケースで改善 |
| 人格指示 | （参考値・ばらつき） | 1.691秒 | 3.1 | 一貫性に課題 |
| 厳格+例示 | （参考値・厳格と同等〜やや低） | 1.273秒 | 3.2 | 時間短縮が顕著 |

### 詳細分析

#### 1. 抽象指示パターン（PATTERN_ABS-EX0-S1-GSHT-genOn）
- **正規化スコア**: ベースライン
- **特徴**: 最小限の指示で基本性能を測定
- **課題**: Level 3の複雑なケースで低下

#### 2. 厳格指示パターン（PATTERN_STRICT-EX0-S1-GSHT-genOn）
- **正規化スコア**: ベースラインより向上
- **改善点**: 
  - Credit Card Level 3: 0% → 100% (大幅改善)
  - Contract Level 2: 追加フィールド抽出成功
- **特徴**: 制約ルールにより出力品質が向上

#### 3. 人格指示パターン（PATTERN_PERSONA-EX0-S1-GSHT-genOn）
- **正規化スコア**: 低下傾向
- **特徴**: プロ秘書の役割を活性化
- **問題点**: 
  - Credit Card Level 1-2: 0% (厳格指示では100%)
  - 複雑なケースでの一貫性に課題
- **成功例**: Credit Card Level 3: 良好（厳格指示と同様）

#### 4. 厳格+例示パターン（PATTERN_STRICT-EX1-S1-GSHT-genOn）
- **正規化スコア**: 厳格と同等〜やや低
- **特徴**: 厳格制約 + few-shot例示
- **改善点**: 
  - 処理時間短縮: 1.273秒（厳格指示の1.725秒から大幅短縮）
  - Contract Level 3: 100% (厳格指示と同様)
- **課題**: Credit Card Level 3で低下

### パターン別詳細結果

#### Credit Card Level 3 の劇的改善
```
抽象指示: 正規化スコア 低
厳格指示: 正規化スコア 高（改善）
```

#### Contract Level 2 の改善
```
抽象指示: title, userID, password, url のみ
厳格指示: title, userID, password, url, host, port 追加
```

## 📈 傾向分析

### 1. 制約の効果
- **厳格指示**により、複雑なケースでの正規化スコアが向上
- 推測禁止・形式統一の指示が効果的
- 特にLevel 3の複雑なテストケースで顕著な改善

### 2. 抽出フィールド数の増加
- 抽象指示: 2.8フィールド/テスト
- 厳格指示: 3.2フィールド/テスト
- 制約により、より多くの関連情報を抽出

### 3. 処理時間への影響
- 厳格指示: 平均1.725秒（抽象より僅かに増）
- 制約処理による若干の時間増加は許容範囲

## 🎯 最終結論と推奨事項

### 最適パターンの選定
1. **厳格指示パターン**が最も高い正規化スコア傾向
2. **厳格+例示パターン**は処理時間短縮に優れる（1.273秒）
3. **人格指示パターン**は一貫性に課題

### 推奨実装戦略
1. **基本**: 厳格指示パターンをデフォルト採用
2. **高速化**: 処理時間重視の場合は厳格+例示パターン
3. **段階的導入**: 厳格指示 → 厳格+例示の順で検証

### 今後の改善方向
1. **2ステップパターン**の検証（複雑ケース対応）
2. **バリデーションエラー**の根本原因調査
3. **Level 3複雑ケース**の専用最適化

## 📝 所感

### 成功要因
- 制約ルールの明確化が抽出精度向上に寄与
- 推測禁止・形式統一の指示が効果的
- 複雑なケースでの改善が顕著

### 課題
- Level 3の一部ケース（Voice Recognition, Password Manager）は依然として困難
- バリデーションエラーの根本原因調査が必要

### 次回実験の期待
- 人格指示パターンでのさらなる改善
- few-shot例示の効果確認
- 2ステップ処理の複雑ケース対応

## 📋 メトリクス定義（generate_combined_report.py と同一方針）

- 正規化スコア (Normalized Score): \( (正解項目数 − 誤り項目数 − 過剰項目数) / 期待項目数 \)
- 正解率 (Correct Rate): \( 正解項目数 / (正解+誤り+欠落+過剰) \)
- 誤り率 (Wrong Rate): \( 誤り項目数 / (正解+誤り+欠落+過剰) \)
- 欠落率 (Missing Rate): \( 欠落項目数 / (正解+誤り+欠落+過剰) \)
- 過剰抽出率 (Unexpected Rate): \( 過剰項目数 / 期待項目数 \)
- Precision: \( 正解 / (正解+誤り+過剰) \)
- Recall: \( 正解 / (正解+欠落) \)

注: 本ドキュメントの集計表示は正規化スコアを主指標とし、詳細の比率は統合レポート（parallel_format_experiment_report.html）と一致する定義で算出されます。

---

**実験完了日時**: 2025年1月10日 22:45  
**実験者**: AI Assistant  
**次回予定**: 人格指示パターンと例示ありパターンの比較実験
