# 実験パターン仕様書

## 概要

このドキュメントでは、@Guideマクロ改善のための実験で使用される8つのパターンについて詳しく説明します。各パターンは、Instructions（指示）、Prompt（プロンプト）、@Guideマクロ、@Generableマクロの組み合わせで構成されており、Apple Foundation Models（AFM）の性能特性を多角的に評価することを目的としています。

## パターン命名規則

各パターン名は以下の形式で構成されています：

```
{pattern}_{algo}_{method}
```

### 命名要素の説明

| 要素 | 値 | 意味 |
|------|-----|------|
| pattern | chat | チャット形式のテストデータ |
| algo | abs | 抽象指示（Abstract） |
| | strict | 厳格指示（Strict） |
| | persona | 人格指示（Persona） |
| | twosteps | 2ステップ処理 |
| | abs-ex | 抽象指示+例示 |
| | strict-ex | 厳格指示+例示 |
| | persona-ex | 人格指示+例示 |
| method | gen | @Generableマクロ使用 |
| | json | JSONフォーマット |
| | yaml | YAMLフォーマット |

## パターン一覧

### 1. chat_abs_gen
**表示名**: Chat・抽象指示・@Generable

**特徴**:
- 最小限の抽象指示で基本性能を測定
- 例示なし、1プロンプト、@Generable使用
- ベースライン性能の測定に使用

**使用場面**:
- 基本性能の測定
- 他のパターンとの比較基準
- 最小構成での性能評価

### 2. chat_abs-ex_gen
**表示名**: Chat・抽象指示(例示)・@Generable

**特徴**:
- 抽象指示にfew-shot例示を追加
- 良例1件で学習効果を確認
- 例示の効果を測定

**使用場面**:
- 例示の効果測定
- 学習効果の評価
- 抽象指示+例示の相乗効果確認

### 3. chat_strict_gen
**表示名**: Chat・厳格指示・@Generable

**特徴**:
- 厳格な制約ルールで出力品質を向上
- 推測禁止、形式統一を強調
- 制約による精度向上効果を測定

**使用場面**:
- 制約の効果測定
- 出力品質の向上確認
- 厳格な指示の有効性評価

### 4. chat_strict-ex_gen
**表示名**: Chat・厳格指示(例示)・@Generable

**特徴**:
- 厳格制約にfew-shot例示を追加
- 制約+学習の相乗効果を測定
- 最高精度を目指すパターン

**使用場面**:
- 最高精度の追求
- 制約+例示の相乗効果測定
- 本番環境での使用候補

### 5. chat_persona_gen
**表示名**: Chat・人格指示・@Generable

**特徴**:
- プロ秘書の役割を活性化
- 専門知識と作業パターンの活用
- 人格設定による性能向上効果を測定

**使用場面**:
- 人格設定の効果測定
- 専門知識の活用確認
- 役割ベースのアプローチ評価

### 6. chat_persona-ex_gen
**表示名**: Chat・人格指示(例示)・@Generable

**特徴**:
- 人格指示にfew-shot例示を追加
- 役割+学習の相乗効果を測定
- 人格設定と例示の組み合わせ効果

**使用場面**:
- 人格+例示の相乗効果測定
- 高度な人格設定の評価
- 複合アプローチの有効性確認

### 7. chat_twosteps_gen
**表示名**: Chat・2ステップ・@Generable

**特徴**:
- 2ステップ処理（タイプ判定→抽出）
- 段階的アプローチの効果を測定
- 複雑なタスクの分割処理

**使用場面**:
- 段階的処理の効果測定
- 複雑なタスクの分割効果
- 2ステップアプローチの評価

### 8. chat_twosteps_json
**表示名**: Chat・2ステップ・JSON

**特徴**:
- 2ステップ処理をJSONフォーマットで実行
- @Generable vs JSONの性能比較
- フォーマットの違いによる性能差測定

**使用場面**:
- @Generable vs JSONの比較
- フォーマットの性能差測定
- 代替手法の評価

## 指示タイプの詳細

### 抽象指示（Abstract）
- **特徴**: 最小限の指示でAIの創造性を最大限発揮
- **例**: "以下のテキストからアカウント情報を抽出してください"
- **目的**: 基本性能の測定、AIの自然な能力評価

### 厳格指示（Strict）
- **特徴**: 詳細な制約ルールで出力品質を向上
- **例**: "推測は禁止、不明な項目は空欄、形式は統一してください"
- **目的**: 精度向上、一貫性確保、エラー削減

### 人格指示（Persona）
- **特徴**: 専門家の役割を設定して関連知識を活性化
- **例**: "あなたはプロの秘書として、以下のデータからアカウント情報を抽出してください"
- **目的**: 専門知識の活用、作業パターンの活性化

## 実験設計の考え方

### 軸別分析
1. **指示タイプ軸**: 抽象 vs 厳格 vs 人格
2. **例示軸**: なし vs あり
3. **ステップ軸**: 1ステップ vs 2ステップ
4. **フォーマット軸**: @Generable vs JSON

### 段階的実験アプローチ
1. **第1段階**: 基本性能測定（ABS-EX0-S1）
2. **第2段階**: 例示効果測定（EX0 vs EX1）
3. **第3段階**: 指示タイプ効果測定（ABS vs STRICT vs PERSONA）
4. **第4段階**: ステップ効果測定（S1 vs S2）
5. **第5段階**: フォーマット比較（@Generable vs JSON）

## 評価指標

### 主要指標
- **正規化スコア**: `(正解項目数 - 誤り項目数 - 余分項目数) / 期待項目数`
- **正解率**: 正解項目数 / 期待項目数
- **精度**: 正解項目数 / (正解項目数 + 誤り項目数)

### 補助指標
- **処理時間**: 参考値（ノイズが大きいため評価には含めない）
- **一貫性**: 複数回実行時の結果の安定性

## 使用方法

### 単一パターン実行
```bash
python3 scripts/run_experiments.py --patterns PATTERN_ABS-EX0-S1-gen --runs 5 --language ja
```

### 複数パターン比較
```bash
python3 scripts/run_experiments.py --patterns PATTERN_ABS-EX0-S1-gen PATTERN_STRICT-EX0-S1-gen --runs 3 --language ja
```

### 10回実験（統計処理）
```bash
python3 scripts/run_10_experiments.py
```

## 実験結果の解釈

### パターン比較の観点
1. **基本性能**: ABS-EX0-S1を基準とした相対性能
2. **例示効果**: EX0 vs EX1の性能差
3. **指示効果**: 抽象 vs 厳格 vs 人格の性能差
4. **ステップ効果**: 1ステップ vs 2ステップの性能差
5. **フォーマット効果**: @Generable vs JSONの性能差

### 推奨パターン選択
- **最高精度**: PATTERN_STRICT-EX1-S1-gen（制約+例示）
- **バランス**: PATTERN_STRICT-EX0-S1-gen（制約のみ）
- **基本性能**: PATTERN_ABS-EX0-S1-gen（最小構成）
- **複雑タスク**: PATTERN_STRICT-EX0-S2-gen（2ステップ）

## 注意事項

1. **実験環境の一貫性**: 同じ環境で全パターンを実行
2. **統計的有意性**: 複数回実行でノイズを除去
3. **テストデータ**: 全パターンで同じテストデータを使用
4. **評価指標**: 正規化スコアを主要指標として使用

## 更新履歴

- 2025-01-10: 初版作成
- 2025-01-10: パターン仕様の詳細化
- 2025-01-10: 実験設計指針の追加
